define(["util"],function(e){function t(){this._events=this._events={}}var i=e;return t.fn=t.prototype={constructor:t,emit:function(e){var t=this._events,n=this._events[e],s=i.isArray(n),r=i.isFunction(n),h=i.isUndefined(n),o=i.slice(i.makeArray(arguments),1);if(h)return!1;if(r&&n.apply(this,o),s){var v,l;if(!t)return!1;if(!n)return!1;for(v=0,l=n.length;l>v;v++)if(n[v].apply(this,o)===!1)return!1}return!0},addListener:function(t,i){var n=(this._events||(this._events={}),this._events[t]),s=e.isUndefined(n),r=e.isFunction(n),h=e.isArray(n),o=e.isFunction(i);if(!o)throw TypeError("listener must be a function");return s&&(this._events[t]=i),r&&(this._events[t]=[n,i]),h&&this._events[t].push(i),this},once:function(t,i){function n(){this.removeListener(t,n),r||(r=!0,i.apply(this,arguments))}var s=e.isFunction(i);if(!s)throw TypeError("listener must be function");var r=!1;return n.listener=i,this.on(t,n),this},removeListener:function(t,i){var n,s=this._events||(this._events={}),r=s[t],h=e.isUndefined(r),o=e.isFunction(r),v=e.isArray(r),l=e.isFunction(r);if(l)throw TypeError("listener must be a function");if(!s||h)return this;if(o||e.isFunction(r.listener)&&r.listener===i)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,i);else if(v){for(n=0,len=r.length,1===len&&(r.length=0,delete this._events[t]),n=0,len=r.length;n<len;n++)if(r[n]===i||r[n].listener&&r[n].listener===i){r[n].splice(n,1);break}if(n==len)return this;this._events.removeListener&&this.emit("removeListener",t,i)}return this},removeAllListeners:function(t){var i,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(i in this._events)"removeListener"!==i&&this.removeAllListeners(i);return this.removeAllListener("removeListener"),this._events={},this}if(listeners=this._events[t],e.isFunction(listeners))this.removeListener(t,listeners);else if(listeners)for(;listeners.length;)this.removeListener(t,listeners[n.length-1]);return delete this._events[t],this},listeners:function(t){var i;return i=this._events&&this._events[t]?e.isFunction(this._events[t])?[this._events[t]]:this._events[t].slice():[]}},t.fn.on=t.prototype.addListener,t});