define(["util","eventemitter","app-chat/view/build/template"],function(t,e,i){function n(t,e){this.member=e,this.el=t,this.removeEvent=[],this["new"]=""}var s=t;return n.prototype={elements:{"section[data-list]":"$dataList","section.online-items":"$onlineItems"}},n=s.eventify(n,e),s.include(n,{init:function(){this._render(),this._initDom(),this._initEvent()},_render:function(){var t=this._template();this.el.innerHTML=t},_template:function(){var t=this.member.getMember();return i("chat_member",t)},_initDom:function(){for(var t in this.elements)this[this.elements[t]]=s.$(t,this.el);this.$mask=s.$("#mask")},_initEvent:function(){var t=this.OpenChat.bind(this);this._addremoveEvent({el:this.$dataList,type:"click",event:t,b:!1}),s.delegate(this.$dataList,"section","click",t,{fn:function(t){var e=t.classList.contains("online-item");return e},useCapture:!0}),this.on("newMsg",this.newMsg.bind(this))},_addremoveEvent:function(t){this.removeEvent.push(t)},_removeEvent:function(){for(var t=this.removeEvent,e=0,i=t.length;i>e;e++)t[e].el.addEventListener(t[e].type,t[e].event,t[e].b)},updateOnlineMember:function(t,e,i){this.datalistId=this.datalistId||[],i=i||{},s.isUndefined(e)||this._updateDom(t,e,i)},_updateDom:function(t,e,i){var n=this.datalistId.indexOf(e);-1===n?(this.datalistId.push(e),this._updateMember(t,i),this._removeEvent(),this._render(),this._initDom(),this._initEvent(),this._moveDom(t,e)):(this._updateMember(t,i),s.$(".count",this.el).innerHTML=i.onlineCount,this._moveDom(t,e))},_updateMember:function(t,e){"online"===t?(e.state=t,this.member.updateMember(e.onlineUsers),this.member.addOnlineCount()):"offline"===t&&(this.member.changeState(e.user),this.member.descOnlineCount())},_moveDom:function(t,e){var i=s.$("[data-listId='"+e+"']");"online"===t?this.$dataList.insertBefore(i,this.$dataList.firstElementChild):"offline"===t&&(i.classList.remove("online"),i.classList.add("offline"),this.$dataList.appendChild(i))},OpenChat:function(t,e){var i=this._OpenChat_data(e);return this._OpenChat_check(i)?!1:(this._OpenChat_render(i),this._OpenChat_initDom(),this._OpenChat_event(i),this.emit("chatBuild"+this["new"],i.id),void(this["new"]=""))},_OpenChat_data:function(t){return{name:s.$("h2",t).innerHTML,imgUrl:s.$("img",t).src,sign:s.$(".online-user > p").innerHTML,id:t.getAttribute("data-listid")}},_OpenChat_check:function(t){return!!s.$("section[data-chatname='"+t.name+"']")},_OpenChat_render:function(t){this.$mask.classList.contains("show")||this.$mask.classList.add("show"),this.$maskChat=document.createElement("div"),this.$maskChat.className="mask-chat",this.$maskChat.setAttribute("data-chatId",t.id);var e=i("chat-box",{chatname:t.name});this.$maskChat.innerHTML=e,this.$mask.appendChild(this.$maskChat)},_OpenChat_initDom:function(){this.$close=s.$(".close",this.$mask),this.$minimize=s.$(".minimize",this.$mask),this.$textarea=s.$("textarea",this.$mask),this.$btn=s.$(".msg_send"),this.$chatfn=s.$All(".chat-fn",this.$mask)},_OpenChat_event:function(t){s.delegate(this.$maskChat,"span","click",this.closeChat.bind(this),{fn:function(t){return"X"===t.innerHTML}}),s.delegate(this.$maskChat,"span","click",this.minimizeChat.bind(this,t),{fn:function(t){return"_"===t.innerHTML}}),s.delegate(this.$maskChat,"textarea","keyup",this.EnterSendMsg.bind(this,t)),s.delegate(this.$maskChat,"button","click",this.BtnSendMsg.bind(this,t)),s.DomforEach(this.$chatfn,function(t){s.drag(this.$maskChat,t)},this),this.on("showChat",this.ShowChat.bind(this)),this.on("cmsg",this.addMsg.bind(this))},ShowChat:function(t){var e=s.$("section[data-chatname='"+t.name+"']",this.$mask).parentElement;e.classList.remove("mz")},closeChat:function(t){this._removeChat(t.currentTarget),this._disconnectChat()},_removeChat:function(t){t.parentElement.removeChild(t),0===this.$mask.childElementCount&&this.$mask.classList.remove("show")},_disconnectChat:function(){alert("disconnect!")},minimizeChat:function(t,e){this._hiddenChat(e.currentTarget),this._emitAddSession(t)},_hiddenChat:function(t){t.classList.add("mz")},_emitAddSession:function(t){this.emit("addsession",t)},EnterSendMsg:function(t,e){13!==e.keyCode&&13!==e.which||this._sendMsg(e.target,t.id)},BtnSendMsg:function(t,e){var i=s.$("textarea",e.target.parentElement);this._sendMsg(i,t.id)},_sendMsg:function(t,e){var i=t.value;t.value="",this.emit("chatMsg",i,e)},addMsg:function(t,e,i,n){var a=s.$("section[data-listId='"+e.from+"']");n=n||{img:s.$("img",a).src,name:s.$("h2",a).innerHTML,sign:s.$("p",a).innerHTML};var h=s.$("div[data-chatId='"+e.box+"']"),m=s.$(".chat-message",h),o=this._MsgTpl(t,i,n),i=s.template(o,"msg");m.appendChild(i)},_MsgTpl:function(t,e,n){return"my"===t?i("my-msg",{imgUrl:n.image,content:e}):"other"===t?i("other-msg",{imgUrl:n.img,sign:n.sign,author:n.name,content:e}):void 0},newMsg:function(t){var e=s.$("section[data-listid='"+t+"']",this.el),i=s.$("span.nothingMsg",e);i.classList.remove("nothingMsg"),i.classList.add("newMsg"),this["new"]="ed"}}),n});