define(["util","eventemitter","socket","app-chat/model/user","app-chat/controller/chat_frame","app-chat/model/member","app-chat/controller/chat_member","app-chat/controller/chat_box","app-chat/model/session","app-chat/controller/chat_session","app-chat/model/login","app-chat/controller/chat_login"],function(t,i,s,o,e,n,h,c,a,r,m,l){function g(t){this.el=u.$(t),this.ioroom={},this.msgArr={},this.isOpen={}}var u=t;return g.prototype={elements:{$login:"#login",$chat_header:".chat-header",$friend:"section[data-face=friend]",$chats:"section[data-face=chats]",$session:"section[data-face=session]"},room:{}},g=u.eventify(g,i),u.include(g,{init:function(){this._initDom(),this._initLogin(),this._initLoginEvent()},_initDom:function(){for(var t in this.elements)this[t]=u.$(this.elements[t],this.el)},_initLogin:function(){this.chat_login=new l(this.$login,m),this.chat_login.init(),this.chat_login.on("log",function(t){this.emit("log",t),this.el.classList.remove("logout")}.bind(this))},_initLoginEvent:function(){this.on("log",this.log.bind(this))},log:function(t){this._initChat_frame(t),this._initSocket(),this._initChat_box(),this._initSession(),this._initEvent()},_initChat_frame:function(t){var i;i="man"===t.sex?u.random(1,3):u.random(4,3),this.user=new o(t.account,"img/pic"+i+".jpg",t.sign),this.chat_frame=new e(this.$chat_header,this.user),this.chat_frame.init(),this.chat_frame.on("tabChange",function(t){console.log("chat_frame"+t),this.emit("tabChange",t)}.bind(this)),this.chat_frame.on("leave",function(){this.emit("logout"),this.el.classList.add("logout")}.bind(this))},_initMember:function(t){this.member=new n(t.onlineUsers,t.onlineCount),this.chat_member=new h(this.$friend,this.member),this.chat_member.init(),this.chat_member.on("addsession",function(t){console.log("chat_member"),console.log(t),this.emit("addsession",t)}.bind(this)),this.chat_member.on("chatBuild",function(t){this.emit("chatBuild",t)}.bind(this)),this.chat_member.on("chatBuilded",function(t){void 0===this.isOpen[t]&&(this.isOpen[t]=!1),this.isOpen[t]=!0;var i,s={};if(s.from=t,s.box=t,this.msgArr[t])for(var o=0,e=this.msgArr[t].length;e>o;o++)i=this.msgArr[t][o],this.chat_member.emit("cmsg","other",s,i)}.bind(this)),this.chat_member.on("chatMsg",function(t,i){this.emit("chatMsg",t,i)}.bind(this))},_initChat_box:function(){this.chat_box=new c(this.$chats),this.chat_box.init(),this.chat_box.on("sendMsg",function(t){this.emit("message",t)}.bind(this))},_initSession:function(){this.session=new a,this.chat_session=new r(this.$session,this.session),this.chat_session.init()},_initEvent:function(){this.on("tabChange",this.faceChange.bind(this)),this.on("addsession",this.addSession.bind(this)),this.on("logout",this.logout.bind(this)),this.on("message",this.message.bind(this)),this.on("chatBuild",this.chatBuild.bind(this)),this.on("chatBuilded",this.chatBuilded.bind(this)),this.on("chatMsg",this.chatMsg.bind(this))},faceChange:function(t){console.log(t);var i=u.$("section[data-face="+t+"]",this.el),s=u.$All("section[data-face]",this.el);s=u.makeArray(s),s.forEach(function(t){t.classList.remove("face_show")}),i.classList.add("face_show")},addSession:function(t){console.log(t),console.log(this.chat_session),console.log(this.chat_session.listeners()),this.chat_session.emit("addsession",t)},logout:function(){this.socket_logout()},message:function(t){var i={user:this.user.getUser(),content:t};this.socket_message(i)},chatBuild:function(t){var i={from:this.user.Uid,to:t,room:this.user.Uid+"to"+t};this.socket_chatBuild(i)},chatBuilded:function(t){this.socket_chatFrom(t),console.log(t.from),this.chat_member.emit("newMsg",t.from)},chatMsg:function(t,i){console.log(this.room);var s=this.room[i],o={from:this.user.Uid,room:s,to:i};this.socket_chatMsg(o,t)},_initSocket:function(){this.socket=s.connect("ws://192.168.1.101:3000"),this.socket_login(this.socket),this.socket.on("login",function(t){this.chat_member?this.chat_member.updateOnlineMember("online",t.user.id,t):(this._initMember(t),console.log(t))}.bind(this)),this.socket.on("logout",function(t){console.log(t),this.chat_member.updateOnlineMember("offline",t.user.id,t)}.bind(this)),this.socket.on("message",function(t){console.log(t);var i=t.user.name===this.user.getAuthor()?"my":"other";console.log("signal"+i),this.chat_box.emit("acceptMsg",t,i)}.bind(this)),this.socket.on("chatSys",function(t){var i=t.to,o=t.room,e=t.from,n=this.user.Uid;if(console.log("userid="+n),i===n){this.socket.emit("join",t);var h=s.connect("ws://192.168.1.101:3000/"+o);console.log(h),this.ioroom[e]=h,this.ioroom[e].on("msg",function(t,i){console.log(t),console.log(i),console.log(this.user.Uid),t.from!==this.user.Uid?(void 0===this.isOpen[t.from]&&(this.isOpen[t.from]=!1),this.isOpen[t.from]?(t.box=t.from,this.chat_member.emit("cmsg","other",t,i)):(this.msgArr[t.from]||(this.msgArr[t.from]=[]),this.msgArr[t.from].push(i))):(console.log("hahahahahah"),t.box=t.to,this.chat_member.emit("cmsg","my",t,i,this.user.getUser()))}.bind(this)),this.emit("chatBuilded",t)}}.bind(this))},socket_login:function(t){var i=this.user.getAuthor(),s=this.user.getImgUrl(),o=this.user.getPersonSign(),e=this.user.Uid=this.getUid();t.emit("login",{name:i,img:s,sign:o,id:e,state:"online"})},socket_logout:function(){this.socket.emit("logout",this.user.Uid)},socket_message:function(t){this.socket.emit("message",t)},socket_chatBuild:function(t){this.room||(this.room={}),this.room[t.to]||(this.room[t.to]=t.room),this.socket.emit("chatBuild",t),console.log(s);var i=s.connect("ws://192.168.1.101:3000/"+t.room);console.log(i),this.ioroom[t.to]=i,this.ioroom[t.to].on("msg",function(t,i){t.from===this.user.Uid?(t.box=t.room.slice(t.room.indexOf("o")+1),console.log(t.box),this.chat_member.emit("cmsg","my",t,i,this.user.getUser())):(t.box=t.from,this.chat_member.emit("cmsg","other",t,i)),console.log(i)}.bind(this))},socket_chatFrom:function(t){this.room||(this.room={}),this.room[t.from]||(this.room[t.from]=t.room)},socket_chatMsg:function(t,i){this.ioroom[t.to].emit("msg",t,i)},getUid:function(){return(new Date).getTime()+""+Math.floor(899*Math.random()+100)}}),g});